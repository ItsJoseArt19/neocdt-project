import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';
import Login from '../../../src/pages/Login';
import * as localStorageUtils from '../../../src/utils/localStorageUtils';

// Mock del módulo localStorageUtils
vi.mock('../../../src/utils/localStorageUtils');

const MockedLogin = () => (
  <BrowserRouter>
    <Login />
  </BrowserRouter>
);

describe('HU-02: Inicio de Sesión - Login Component', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    localStorage.clear();
  });

  describe('Scenario: Login exitoso con credenciales válidas', () => {
    it('Given usuario con credenciales válidas, When completa el formulario y hace clic en Iniciar Sesión, Then debería iniciar sesión exitosamente', async () => {
      // Given
      const mockUser = {
        documentType: 'CC',
        documentNumber: '1234567890',
        name: 'Juan Pérez',
        password: '1234'
      };
      
      vi.mocked(localStorageUtils.loginUser).mockReturnValue(mockUser);
      vi.mocked(localStorageUtils.setCurrentUser).mockImplementation(() => {});

      render(<MockedLogin />);

      // When
      const documentTypeSelect = screen.getByLabelText(/tipo de documento/i);
      const documentNumberInput = screen.getByLabelText(/número de documento/i);
      const passwordInput = screen.getByLabelText(/contraseña/i);
      const submitButton = screen.getByRole('button', { name: /iniciar sesión/i });

      fireEvent.change(documentTypeSelect, { target: { value: 'CC' } });
      fireEvent.change(documentNumberInput, { target: { value: '1234567890' } });
      fireEvent.change(passwordInput, { target: { value: '1234' } });
      fireEvent.click(submitButton);

      // Then
      await waitFor(() => {
        expect(localStorageUtils.loginUser).toHaveBeenCalledWith('CC', '1234567890', '1234');
        expect(localStorageUtils.setCurrentUser).toHaveBeenCalledWith(mockUser);
      });
    });
  });

  describe('Scenario: Intento de login con contraseña incorrecta', () => {
    it('Given usuario con contraseña incorrecta, When intenta iniciar sesión, Then debería mostrar error de credenciales inválidas', async () => {
      // Given
      vi.mocked(localStorageUtils.loginUser).mockReturnValue(null);

      render(<MockedLogin />);

      // When
      const documentTypeSelect = screen.getByLabelText(/tipo de documento/i);
      const documentNumberInput = screen.getByLabelText(/número de documento/i);
      const passwordInput = screen.getByLabelText(/contraseña/i);
      const submitButton = screen.getByRole('button', { name: /iniciar sesión/i });

      fireEvent.change(documentTypeSelect, { target: { value: 'CC' } });
      fireEvent.change(documentNumberInput, { target: { value: '1234567890' } });
      fireEvent.change(passwordInput, { target: { value: 'Pass9999' } });
      fireEvent.click(submitButton);

      // Then
      await waitFor(() => {
        expect(localStorageUtils.loginUser).toHaveBeenCalledWith('CC', '1234567890', 'Pass9999');
        expect(localStorageUtils.setCurrentUser).not.toHaveBeenCalled();
      });
    });
  });

  describe('Scenario: Intento de login sin completar campos requeridos', () => {
    it('Given formulario vacío, When intenta iniciar sesión, Then debería mostrar mensajes de validación', async () => {
      // Given
      render(<MockedLogin />);

      // When
      const submitButton = screen.getByRole('button', { name: /iniciar sesión/i });
      fireEvent.click(submitButton);

      // Then - el formulario HTML5 previene el submit con campos vacíos
      expect(localStorageUtils.loginUser).not.toHaveBeenCalled();
    });
  });

  describe('Scenario: Validación de formato de documento', () => {
    it('Given documento CC válido, When ingresa 10 dígitos, Then debería aceptar el formato', () => {
      // Given
      render(<MockedLogin />);

      // When
      const documentTypeSelect = document.getElementById('documentType');
      const documentNumberInput = document.getElementById('documentNumber');

      fireEvent.change(documentTypeSelect, { target: { value: 'CC' } });
      fireEvent.change(documentNumberInput, { target: { value: '1234567890' } });

      // Then
      expect(documentNumberInput.value).toBe('1234567890');
    });

    it('Given documento CE válido, When ingresa entre 6 y 10 dígitos, Then debería aceptar el formato', () => {
      // Given
      render(<MockedLogin />);

      // When
      const documentTypeSelect = document.getElementById('documentType');
      const documentNumberInput = document.getElementById('documentNumber');

      fireEvent.change(documentTypeSelect, { target: { value: 'CE' } });
      fireEvent.change(documentNumberInput, { target: { value: '123456' } });

      // Then
      expect(documentNumberInput.value).toBe('123456');
    });
  });

  describe('Scenario: Navegación a registro', () => {
    it('Given usuario sin cuenta, When hace clic en "Crear cuenta", Then debería navegar a registro', () => {
      // Given
      render(<MockedLogin />);

      // When
      const registerLink = screen.getByText(/crear cuenta|registrarse/i);

      // Then
      expect(registerLink).toBeDefined();
      expect(registerLink.getAttribute('href')).toMatch(/register/i);
    });
  });
});
